# Обработчик RTSP потоков с детекцией пересечения линии

## Описание

Новая система работает напрямую с RTSP потоками двух камер:
- **Номерная камера**: детектирует пересечение линии и распознает номера
- **Снеговая камера**: захватывает кадры для анализа снега

При пересечении линии системой:
1. Детектируется машина на номерной камере
2. Распознается номер через ANPR
3. Захватывается кадр со снеговой камеры
4. Оба кадра отправляются в Gemini для анализа
5. Результаты отправляются на upstream сервис

## Настройка

### Переменные окружения

```bash
# RTSP потоки камер
PLATE_CAMERA_RTSP=rtsp://admin:Armat456321@178.22.170.254:554/streaming/channels/101
SNOW_CAMERA_RTSP=rtsp://admin:Armat456321@178.22.170.254:555/streaming/channels/101

# Позиция линии пересечения (0.0-1.0, где 0.6 = 60% от верха кадра)
# 0.0 = верх кадра, 1.0 = низ кадра
# Рекомендуется: 0.5-0.7 для горизонтальных дорог
LINE_Y_POSITION=0.6

# Направление пересечения ("down" = сверху вниз, "up" = снизу вверх)
# "down" - машина едет сверху вниз (пересекает линию движением вниз)
# "up" - машина едет снизу вверх (пересекает линию движением вверх)
LINE_DIRECTION=down

# Отображение потоков в окне (для отладки и настройки линии)
# Включите для визуальной настройки позиции линии
SHOW_STREAM_WINDOW=false

# Минимальная уверенность детекции
STREAM_MIN_CONFIDENCE=0.5

# Минимальная площадь bbox для детекции
STREAM_MIN_BBOX_AREA=10000

# Настройки трекинга
TRACK_MAX_AGE=30          # Максимальный возраст трека в кадрах
TRACK_MIN_HITS=3          # Минимальное количество попаданий для создания трека
TRACK_IOU_THRESHOLD=0.3    # Порог IoU для сопоставления треков

# Окно дедупликации (секунды)
STREAM_DEDUP_WINDOW_SECONDS=5.0

# Включить/выключить обработчик потоков
ENABLE_STREAM_PROCESSOR=true

# ID камеры
PLATE_CAMERA_ID=camera-001

# URL для отправки событий
UPSTREAM_URL=https://snowops-anpr-service.onrender.com/api/v1/anpr/events

# Gemini API ключ
GEMINI_API_KEY=your_api_key_here
GEMINI_MODEL=gemini-2.5-flash
```

## Запуск

Обработчик потоков автоматически запускается при старте приложения, если `ENABLE_STREAM_PROCESSOR=true`.

### API endpoints

- `GET /stream/status` - Проверить статус обработчика
- `POST /stream/start` - Запустить обработчик вручную
- `POST /stream/stop` - Остановить обработчик

## Логика работы

1. **Чтение потоков**:
   - Номерная камера: основной поток для детекции пересечения
   - Снеговая камера: буферизуется в памяти (последние 3 секунды)

2. **Детекция машин**:
   - Используется YOLO модель для детекции машин (классы 2=car, 7=truck)
   - Фильтрация по минимальной уверенности и площади

3. **Трекинг**:
   - Отслеживание машин между кадрами через IoU
   - Определение пересечения линии по изменению позиции центра

4. **Обработка пересечения**:
   - При пересечении линии захватывается кадр с номерной камеры
   - Захватывается последний кадр из снегового буфера
   - Распознается номер через ANPR
   - Оба кадра отправляются в Gemini
   - Результаты отправляются на upstream

5. **Дедупликация**:
   - Предотвращение повторной обработки одного номера в течение окна времени

## Настройка линии пересечения

### Визуальная настройка (рекомендуется):

1. Включите отображение потоков в `app.env`:
   ```env
   SHOW_STREAM_WINDOW=true
   ```

2. Запустите сервис - откроется окно с видео потоком

3. В окне вы увидите:
   - **Зеленая/красная линия** - линия пересечения
   - **Синие прямоугольники** - детекции машин
   - **Оранжевые/зеленые прямоугольники** - треки машин
   - **Зеленые треки** - машины, которые пересекли линию

4. Настройте `LINE_Y_POSITION` в `app.env`:
   - Уменьшите значение (например, 0.4) - линия поднимется выше
   - Увеличьте значение (например, 0.8) - линия опустится ниже
   - Перезапустите сервис для применения изменений

5. Настройте `LINE_DIRECTION`:
   - `down` - если машины едут сверху вниз
   - `up` - если машины едут снизу вверх

### Параметры настройки:

- `LINE_Y_POSITION` (0.0-1.0): Позиция линии
  - 0.0 = верх кадра
  - 0.5 = середина кадра
  - 1.0 = низ кадра
  - Рекомендуется: 0.5-0.7 для горизонтальных дорог

- `LINE_DIRECTION`: Направление пересечения
  - `down` - машина пересекает линию движением вниз
  - `up` - машина пересекает линию движением вверх

- `STREAM_MIN_CONFIDENCE` (0.0-1.0): Минимальная уверенность детекции
  - Уменьшите (например, 0.3) для более чувствительной детекции
  - Увеличьте (например, 0.7) для более строгой детекции

- `STREAM_MIN_BBOX_AREA`: Минимальная площадь детекции
  - Уменьшите для детекции маленьких машин
  - Увеличьте для игнорирования маленьких объектов

## Отладка

Для отладки можно использовать:
- **Визуальное окно**: Включите `SHOW_STREAM_WINDOW=true` для отображения потоков
- **Логи**: 
  - `[STREAM]` - логи обработчика потоков
  - `[GEMINI]` - логи анализа через Gemini
  - `[UPSTREAM]` - логи отправки на upstream

## Требования

- OpenCV с поддержкой RTSP
- YOLO модель (по умолчанию yolov8n.pt)
- ANPR движок
- Gemini API ключ

